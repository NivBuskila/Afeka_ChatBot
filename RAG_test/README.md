# 🧪 מערכת בדיקה מלאה לRAG - מכללת אפקה

## 📋 תיאור כללי

מערכת בדיקה מקיפה עבור מערכת ה-RAG (Retrieval-Augmented Generation) של צ'אטבוט מכללת אפקה. המערכת בודקת 30 שאלות בקטגוריות שונות ויוצרת דוחות מפורטים על הביצועים.

## 📁 מבנה הקבצים

```
RAG_test/
├── 📋 README.md                    # הוראות הפעלה (קובץ זה)
├── 🧪 test_runner.py               # הסקריפט הראשי לביצוע הבדיקות
├── 📊 test_questions.json          # 30 שאלות בדיקה מחולקות לקטגוריות
└── 📂 results/                     # תיקיית תוצאות (נוצרת אוטומטית)
    ├── 📄 test_report_[timestamp].txt          # דוח מפורט בעברית
    ├── 📊 rag_settings_[timestamp].json        # הגדרות מערכת נוכחיות
    ├── 🔍 chunks_analysis_[timestamp].txt      # ניתוח מפורט של צ'אנקים
    ├── 🗃️ raw_results_[timestamp].json         # נתונים גולמיים JSON
    └── 🐛 test_debug.log                       # לוג דיבוג
```

## 🎯 קטגוריות שאלות

### 🔍 דיוק מספרי סעיפים (8 שאלות)

בדיקת יכולת המערכת לזהות ולהחזיר סעיפים ספציפיים לפי מספר:

- שאלות פשוטות: סעיפים ברמה הראשונה
- שאלות מורכבות: סעיפים מקוננים (למשל 6.2.7.4)
- שאלות מלכודת: סעיפים לא קיימים

### 🧠 שאלות תוכן מורכבות (8 שאלות)

בדיקת יכולת להבין ולענות על שאלות רחבות:

- פטורים מקורסים
- חישוב ציונים
- תנאי מעבר
- הרחקה אקדמית

### ⚖️ שאלות משמעת (7 שאלות)

בדיקת זיהוי ותשובה על נושאי משמעת:

- עבירות משמעת
- הליכי תלונה
- זכויות סטודנטים
- עונשים

### 🤔 שאלות אמביגואליות (4 שאלות)

שאלות עם מספר תשובות אפשריות או הקשרים שונים

### 🪤 שאלות מלכודת (3 שאלות)

שאלות על נושאים שלא קיימים במסמכים כדי לבדוק תגובה נכונה

## 🚀 הפעלת הבדיקה

### דרישות מוקדמות

1. **Python 3.8+** עם הספריות הנדרשות
2. **משתני סביבה** מוגדרים ב-`.env`:
   ```env
   GEMINI_API_KEY=your_gemini_api_key
   SUPABASE_URL=your_supabase_url
   SUPABASE_KEY=your_supabase_key
   ```
3. **מסד נתונים Supabase** עם מסמכים מעובדים
4. **שירות backend** פעיל (אופציונלי)

### שלבי ההפעלה

1. **ניווט לתיקיית הפרויקט:**

   ```bash
   cd /path/to/Afeka_ChatBot
   ```

2. **הפעלת הבדיקה:**

   ```bash
   python RAG_test/test_runner.py
   ```

3. **המתנה לסיום** (בערך 1-2 דקות)

4. **בדיקת התוצאות** בתיקיית `RAG_test/results/`

### דוגמה להפעלה מוצלחת

```
🚀 מתחיל בדיקת מערכת RAG...
==================================================
INFO - מאתחל שירותי RAG...
INFO - שירותים אותחלו בהצלחה
INFO - בודק שאלה #1: מה אומר סעיף 1.5.1?
INFO - בודק שאלה #2: מה כתוב בסעיף 2.1?
...
INFO - בדיקות הושלמו!

📊 יוצר דוחות...

✅ בדיקה הושלמה בהצלחה!
📈 תוצאות:
   - שאלות נבדקו: 30
   - שיעור הצלחה: 76.7%
   - זמן ממוצע: 1,850ms

📁 הדוחות נשמרו בתיקיית: RAG_test/results/
```

## 📊 הבנת התוצאות

### דוח ראשי (`test_report_[timestamp].txt`)

**סיכום תוצאות:**

- ✅ **תשובות נכונות**: תשובות מדויקות ומלאות
- ⚠️ **תשובות חלקיות**: סעיף נכון אבל תוכן חסר
- ❌ **תשובות שגויות**: סעיף שגוי או תוכן לא רלוונטי

**ניתוח לכל שאלה:**

- זמן תגובה במילישניות
- צ'אנקים שנבחרו וציוני הדמיון שלהם
- הערכת דיוק מפורטת
- תוכן התשובה

### ניתוח צ'אנקים (`chunks_analysis_[timestamp].txt`)

- התפלגות ציוני דמיון
- מסמכים שנבחרו הכי הרבה
- סעיפים שזוהו בתדירות גבוהה
- סטטיסטיקות כלליות על איכות החיפוש

### הגדרות מערכת (`rag_settings_[timestamp].json`)

נתונים טכניים על התצורה הנוכחית:

```json
{
  "rag_settings": {
    "max_context_tokens": 6000,
    "similarity_threshold": 0.65,
    "max_chunks": 8
  },
  "chat_settings": {
    "gemini_model": "gemini-2.0-flash",
    "temperature": 0.7,
    "max_tokens": 1024
  }
}
```

## 🔧 פרמטרים לכוונן

### הגדרות RAG עיקריות

בקובץ `src/backend/services/rag_service.py`:

```python
self.max_context_tokens = 6000      # מקס טוקנים בקונטקסט
self.similarity_threshold = 0.65    # סף דמיון מינימלי
self.max_chunks = 8                 # מספר צ'אנקים מקסימלי
```

### המלצות כוונון על סמך תוצאות

**שיעור הצלחה נמוך (<70%):**

- הנמך `similarity_threshold` ל-0.5
- הגדל `max_chunks` ל-12
- בדוק איכות הembeddings

**זמן תגובה איטי (>3 שניות):**

- הקטן `max_chunks` ל-6
- הקטן `max_context_tokens` ל-4000
- אופטם שאילתות מסד נתונים

**בעיות בזיהוי סעיפים:**

- שפר regex לזיהוי מספרי סעיפים
- הוסף משקל נוסף לmetadata של סעיפים
- בדוק preprocessing של המסמכים

## 🐛 פתרון בעיות

### שגיאות אתחול

**שגיאה: "GEMINI_API_KEY not found"**

```bash
# בדוק שקובץ .env קיים וכולל:
GEMINI_API_KEY=your_actual_api_key
```

**שגיאה: "Failed to initialize RAG service"**

```bash
# בדוק חיבור ל-Supabase:
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_KEY=your_supabase_key
```

### שגיאות ריצה

**שגיאה: "No results from RAG service"**

- בדוק שיש מסמכים מעובדים במסד הנתונים
- בדוק שהembeddings נוצרו בהצלחה
- נסה להוריד את `similarity_threshold`

**זמן תגובה איטי מאוד (>10 שניות)**

- בדוק ביצועי Supabase
- בדוק שהאינדקסים פעילים
- נסה עם פחות שאלות בו-זמנית

### בדיקת תקינות מערכת

```bash
# בדיקה מהירה של 5 שאלות ראשונות:
python -c "
import json
data = json.load(open('RAG_test/test_questions.json'))
data['questions'] = data['questions'][:5]
json.dump(data, open('RAG_test/test_questions_quick.json', 'w'), ensure_ascii=False, indent=2)
"

# הרצה עם הקובץ המקוצר
# (לשנות בtest_runner.py את השם)
```

## 📈 שיפור הביצועים

### אופטימיזציות מומלצות

1. **הגדלת cache** לembeddings
2. **שיפור preprocessing** של שאלות
3. **כוונון fine** של similarity threshold לפי נושא
4. **הוספת re-ranking** לתוצאות חיפוש
5. **אופטימיזציה של prompt engineering**

### מדדים להצלחה

- **שיעור הצלחה**: מעל 80%
- **זמן תגובה**: מתחת ל-2 שניות
- **דיוק סעיפים**: מעל 90% לשאלות פשוטות
- **טיפול מלכודות**: מעל 80% זיהוי נכון

## 🔄 הרצה תקופתית

מומלץ להריץ את הבדיקה:

- **לאחר כל שינוי** בפרמטרי RAG
- **לאחר הוספת מסמכים** חדשים
- **אחת לשבוע** לניטור ביצועים
- **לפני deployment** לפרודקשן

## 🆘 תמיכה

אם נתקלת בבעיות:

1. בדוק את קובץ הלוג: `RAG_test/results/test_debug.log`
2. וודא שכל התלויות מותקנות
3. בדוק חיבור לשירותים חיצוניים
4. פנה למפתח המערכת עם הלוגים המלאים

---

**נוצר על ידי מערכת הבדיקה האוטומטית של RAG מכללת אפקה** 🎓
